# 数字贸易培训平台实验开发标准

## 概述

本文档定义了数字贸易培训平台中所有实验任务开发的统一标准和最佳实践。基于任务1（海关企业资质备案）、任务2（电子口岸IC卡申请）和任务3（电商企业资质备案）的开发经验总结制定。

## 1. 强制自动预填要求 (Mandatory Auto-prefill Requirements)

### 1.1 完全静默原则
- **无感知预填**：所有实验任务表单必须在组件挂载时自动预填测试数据，无任何用户通知或UI指示器
- **零用户交互**：预填过程完全在后台进行，不显示toast通知、弹窗或选择器
- **静默加载**：使用TanStack Query获取测试数据，不显示加载状态或错误提示

### 1.2 数据源规范
- **数据库驱动**：测试数据存储在MySQL数据库中，每个实验都有对应的测试数据表
- **API端点规范**：通过 `/api/test-data/<实验key>` 端点获取测试数据
- **数据格式**：API返回格式为 `{success: true, data: [测试数据数组]}`
- **默认数据集**：总是使用"默认测试企业"数据集进行静默预填

### 1.3 表单预填规则
- **字段映射**：确保数据库字段与表单字段正确映射，处理字段名差异
- **数组字段处理**：正确处理数组字段的分割（如经营范围用"；"分割，认证用", "分割）
- **同意复选框**：预填时保持所有同意复选框为false（未选中）状态
- **容错处理**：对缺失字段提供默认值，确保预填不会导致表单错误

## 2. 实验元数据标准 (Experiment Metadata Standards)

### 2.1 核心流程定义
- **coreFlow字段**：每个实验必须在数据库experiments表中定义准确的coreFlow（核心步骤）
- **步骤展示**：实验详情页根据元数据动态显示实验流程步骤和图标
- **进度同步**：通过 `/api/progress` 端点同步学生进度状态

### 2.2 实验流程设计
- **任务1**：海关企业资质备案 - 6步核心流程
- **任务2**：电子口岸IC卡申请 - 标准流程步骤
- **任务3**：电商企业资质备案 - 6步核心流程设计
- **步骤一致性**：相同类型实验保持步骤数量和命名一致

## 3. UX一致性要求 (UX Consistency Requirements)

### 3.1 技术栈标准
- **表单技术栈**：使用shadcn + react-hook-form + zodResolver
- **路由管理**：使用wouter进行客户端路由
- **查询管理**：TanStack Query v5，使用分层queryKeys，变更后缓存失效
- **样式系统**：Tailwind CSS + shadcn/ui组件库

### 3.2 用户交互模式
- **加载状态**：显示加载/骨架状态，使用.isLoading和.isPending
- **错误处理**：优雅处理401错误，显示重新登录提示
- **图标标准**：使用lucide-react图标库，保持图标风格一致
- **文件上传**：使用共享的FileUpload组件

### 3.3 可测试性要求
- **测试标识**：所有交互元素和关键显示元素添加data-testid属性
- **命名规范**：`{action}-{target}` 或 `{type}-{content}-{id}`
- **动态元素**：为动态生成的元素添加唯一标识符

## 4. 导航和流程标准 (Navigation and Flow Standards)

### 4.1 页面流程设计
- **详情优先**：用户首先看到实验详情页，了解实验目标和步骤
- **主动启动**：用户主动点击"开始实验"按钮启动表单
- **返回场景**：标准的返回到场景导航，使用一致的返回按钮
- **进度追踪**：一致的按钮标签、图标和步骤器

### 4.2 认证处理
- **Token管理**：统一的JWT访问令牌和刷新令牌管理
- **401处理**：实现robust的isAuthError()检测和处理
- **重试机制**：自动刷新token，对失败的API请求进行重试
- **优雅降级**：认证失败时显示明确的重新登录提示

## 5. 数据库设计标准 (Database Design Standards)

### 5.1 数据库连接和配置
- **强制数据库存储**：所有数据（包括测试数据、实验数据、用户数据）都必须写入PostgreSQL数据库
- **数据库调用**：所有数据获取都必须从数据库调用，不允许使用硬编码或本地存储
- **连接管理**：使用环境变量DATABASE_URL进行数据库连接，确保安全性
- **连接池**：使用连接池管理数据库连接，提高性能和稳定性

### 5.2 测试数据表结构
- **命名规范**：`{实验类型}_test_data` (如：customs_test_data, ic_card_test_data)
- **主键规范**：使用有意义的字符串ID (如：custom-test-default-001)
- **字段命名**：使用snake_case命名，与表单字段区分
- **数据完整性**：确保测试数据包含所有必要字段
- **数据持久化**：所有测试数据集都必须持久化存储在数据库中

### 5.3 实验元数据
- **experiments表**：存储实验基本信息和coreFlow
- **progress表**：记录学生实验进度
- **关联关系**：正确设置外键关系和约束
- **数据一致性**：确保所有相关数据都存储在同一数据库实例中

### 5.4 数据库操作规范
- **CRUD操作**：所有数据创建、读取、更新、删除都通过数据库操作
- **事务管理**：复杂操作使用数据库事务确保数据一致性
- **数据验证**：在数据库层面和应用层面都进行数据验证
- **备份策略**：重要数据的定期备份和恢复机制

## 6. API设计标准 (API Design Standards)

### 6.1 端点规范
- **实验数据**：`GET /api/experiments` - 获取实验列表
- **进度数据**：`GET /api/progress` - 获取学生进度
- **测试数据**：`GET /api/test-data/{experimentKey}` - 获取测试数据
- **文件上传**：`POST /api/upload` - 文件上传处理

### 6.2 响应格式
- **成功响应**：`{success: true, data: 实际数据}`
- **错误响应**：`{success: false, message: "错误信息"}`
- **一致性**：所有API保持响应格式一致

## 7. 错误处理和调试 (Error Handling and Debugging)

### 7.1 客户端错误处理
- **网络错误**：优雅处理网络连接问题
- **认证错误**：自动token刷新和重新登录提示
- **数据错误**：验证和容错处理
- **表单错误**：清晰的字段级错误提示

### 7.2 调试支持
- **开发日志**：开发环境下的详细日志记录
- **生产安全**：生产环境移除调试代码
- **错误边界**：React错误边界捕获组件错误

## 8. 性能优化标准 (Performance Optimization Standards)

### 8.1 数据获取优化
- **并行请求**：独立API调用并行执行
- **缓存策略**：合理使用TanStack Query缓存
- **懒加载**：大型组件和数据的懒加载
- **缓存失效**：数据变更后及时失效相关缓存

### 8.2 渲染优化
- **组件记忆化**：适当使用React.memo和useMemo
- **虚拟化**：长列表使用虚拟滚动
- **代码分割**：路由级别的代码分割

## 9. 安全性要求 (Security Requirements)

### 9.1 数据安全
- **敏感信息**：不在前端暴露敏感数据
- **输入验证**：所有用户输入进行验证
- **XSS防护**：防止跨站脚本攻击
- **CSRF保护**：防止跨站请求伪造

### 9.2 认证安全
- **Token安全**：安全存储和传输JWT token
- **权限控制**：基于角色的访问控制
- **会话管理**：安全的会话管理机制

## 10. 代码质量标准 (Code Quality Standards)

### 10.1 代码规范
- **TypeScript**：强类型检查，避免any类型
- **ESLint规则**：遵循项目ESLint配置
- **代码格式**：统一的代码格式化
- **命名规范**：清晰的变量和函数命名

### 10.2 组件设计
- **单一职责**：每个组件只负责一个功能
- **可复用性**：设计可复用的通用组件
- **Props接口**：清晰定义组件Props类型
- **默认值**：为Props提供合理默认值

## 11. 测试标准 (Testing Standards)

### 11.1 单元测试
- **组件测试**：关键组件的单元测试
- **工具函数**：纯函数的单元测试
- **覆盖率**：保持合理的测试覆盖率

### 11.2 集成测试
- **API集成**：前后端API集成测试
- **用户流程**：关键用户流程的端到端测试
- **数据一致性**：数据流的一致性测试

## 12. 部署和维护标准 (Deployment and Maintenance Standards)

### 12.1 部署流程
- **环境管理**：开发、测试、生产环境分离
- **配置管理**：环境相关配置外部化
- **版本控制**：语义化版本管理

### 12.2 监控和日志
- **性能监控**：关键指标监控
- **错误跟踪**：错误日志收集和分析
- **用户行为**：用户操作行为分析

## 13. 文档标准 (Documentation Standards)

### 13.1 代码文档
- **注释规范**：重要逻辑添加注释说明
- **API文档**：完整的API接口文档
- **组件文档**：组件使用说明和示例

### 13.2 开发文档
- **开发指南**：详细的开发环境设置
- **部署指南**：完整的部署流程文档
- **故障排除**：常见问题和解决方案

## 版本历史

- **v1.0** (2025-09-16): 基于任务1、2、3开发经验制定初始标准
- 后续版本将根据新的实验任务开发经验持续更新完善

---

**注意：本标准为强制性开发要求，所有新的实验任务开发都必须严格遵循本标准。**